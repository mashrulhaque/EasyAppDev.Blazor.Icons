#!/usr/bin/env python3
"""
EasyAppDev.Blazor.Icons - Physical Component Generator

This script generates individual physical .cs component files for each icon.
Each icon becomes a separate sealed ComponentBase class that can be trimmed independently.

This enables true trimming - only referenced icons are included in published output.

Configuration is loaded from icon-sets.json for easy customization.
"""

import json
import os
import re
import sys
from pathlib import Path
from typing import Dict, Optional

# Configuration file path
CONFIG_FILE = "icon-sets.json"

# Component template for better maintainability
COMPONENT_TEMPLATE = """// <auto-generated/>
#nullable enable

using Microsoft.AspNetCore.Components;
using Microsoft.AspNetCore.Components.Rendering;

namespace {namespace}
{{
    /// <summary>
    /// {icon_name} icon from icon library.
    /// This component is fully embedded and trimmable.
    /// </summary>
    public sealed class {icon_name} : ComponentBase
    {{
        /// <summary>
        /// Accessible label for the icon. If not provided, icon will be marked as decorative (aria-hidden="true").
        /// </summary>
        [Parameter]
        public string? AriaLabel {{ get; set; }}

        /// <summary>
        /// Additional HTML attributes to apply to the SVG element.
        /// </summary>
        [Parameter(CaptureUnmatchedValues = true)]
        public System.Collections.Generic.IReadOnlyDictionary<string, object>? AdditionalAttributes {{ get; set; }}

        /// <inheritdoc/>
        protected override void BuildRenderTree(RenderTreeBuilder builder)
        {{
            builder.OpenElement(0, "svg");
            builder.AddAttribute(1, "xmlns", "http://www.w3.org/2000/svg");
            builder.AddAttribute(2, "viewBox", "{viewbox}");
            builder.AddAttribute(3, "width", "24");
            builder.AddAttribute(4, "height", "24");

            {default_attributes}

            // Add user attributes AFTER defaults so they can override
            if (AdditionalAttributes != null)
            {{
                builder.AddMultipleAttributes(10, AdditionalAttributes);
            }}

            // Accessibility attributes
            if (!string.IsNullOrEmpty(AriaLabel))
            {{
                builder.AddAttribute(11, "role", "img");
                builder.AddAttribute(12, "aria-label", AriaLabel);
            }}
            else
            {{
                builder.AddAttribute(11, "aria-hidden", "true");
            }}

            // Inline SVG content
            builder.AddMarkupContent(13, @"{svg_content}");
            builder.CloseElement();
        }}
    }}
}}
"""


def check_python_version():
    """Ensure Python 3.7+ is being used"""
    if sys.version_info < (3, 7):
        print("ERROR: Python 3.7 or higher is required")
        print(f"Current version: {sys.version}")
        sys.exit(1)


def load_config(config_path: Path) -> Dict:
    """Load icon sets configuration from JSON file"""
    if not config_path.exists():
        print(f"\033[1;31mERROR: Configuration file not found: {config_path}\033[0m")
        print("Please ensure icon-sets.json exists in the generator directory.")
        sys.exit(1)

    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)

        if 'iconSets' not in config:
            print(f"\033[1;31mERROR: Invalid configuration - missing 'iconSets' key\033[0m")
            sys.exit(1)

        return config['iconSets']
    except json.JSONDecodeError as e:
        print(f"\033[1;31mERROR: Invalid JSON in configuration file: {e}\033[0m")
        sys.exit(1)


def convert_config_keys(config: Dict) -> Dict:
    """Convert camelCase JSON keys to snake_case Python keys"""
    key_mapping = {
        'packageDir': 'package_dir',
        'strokeWidth': 'stroke_width',
        'strokeLinecap': 'stroke_linecap',
        'strokeLinejoin': 'stroke_linejoin',
        'stripSuffix': 'strip_suffix'
    }

    result = {}
    for key, value in config.items():
        new_key = key_mapping.get(key, key)
        result[new_key] = value
    return result


def validate_icon_name(name: str) -> Optional[str]:
    """
    Validate and sanitize icon name

    Returns error message if invalid, None if valid
    """
    if not name:
        return "Icon name is empty"

    if len(name) > 100:
        return f"Icon name too long: {name}"

    # Check for invalid characters
    if not re.match(r'^[a-zA-Z0-9_-]+$', name):
        return f"Icon name contains invalid characters: {name}"

    return None


def convert_to_valid_identifier(name: str, prefix: str = "", strip_suffix: str = "") -> str:
    """Convert filename to valid C# identifier with optional prefix and suffix stripping"""
    name = Path(name).stem

    # Strip size/variant suffix if specified (e.g., _24_filled -> _filled)
    if strip_suffix:
        # For FluentUI: home_24_filled -> home_filled, home_24_regular -> home_regular
        name = name.replace(strip_suffix + "_", "_")

    # Split on both hyphen and underscore for conversion
    # home_filled -> HomeFilled, arrow-right -> ArrowRight
    parts = name.replace('_', '-').split('-')
    result = ''.join(part.capitalize() for part in parts)

    if result and result[0].isdigit():
        result = f"_{result}"

    # Prepend prefix if provided
    if prefix:
        result = f"{prefix}{result}"

    return result


def extract_svg_content(svg_path: Path) -> Optional[str]:
    """Extract inner SVG content from SVG file"""
    try:
        if not svg_path.exists():
            print(f"ERROR: SVG file not found: {svg_path}")
            return None

        with open(svg_path, 'r', encoding='utf-8') as f:
            content = f.read()

        if not content.strip():
            print(f"WARNING: Empty SVG file: {svg_path}")
            return None

        pattern = r'<svg[^>]*>(.*?)</svg>'
        match = re.search(pattern, content, re.DOTALL)

        if match:
            inner_content = match.group(1).strip()
            # Escape quotes for C# verbatim string
            inner_content = inner_content.replace('"', '""')
            # Clean up whitespace but preserve structure
            inner_content = re.sub(r'\n\s+', ' ', inner_content)
            return inner_content.strip()
        else:
            print(f"WARNING: No SVG content found in {svg_path}")
            return None
    except UnicodeDecodeError as e:
        print(f"ERROR: Failed to decode {svg_path}: {e}")
        return None
    except Exception as e:
        print(f"ERROR: Failed to parse {svg_path}: {e}")
        return None


def generate_default_attributes(config: Dict[str, Optional[str]]) -> str:
    """Generate default SVG attribute assignments"""
    lines = []
    attr_num = 5

    if config.get('fill'):
        lines.append(f'            builder.AddAttribute({attr_num}, "fill", "{config["fill"]}");')
        attr_num += 1

    if config.get('stroke'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke", "{config["stroke"]}");')
        attr_num += 1

    if config.get('stroke_width'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-width", "{config["stroke_width"]}");')
        attr_num += 1

    if config.get('stroke_linecap'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-linecap", "{config["stroke_linecap"]}");')
        attr_num += 1

    if config.get('stroke_linejoin'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-linejoin", "{config["stroke_linejoin"]}");')
        attr_num += 1

    return '\n'.join(lines)


def generate_component_file(icon_name: str, svg_content: str, config: Dict[str, Optional[str]]) -> str:
    """Generate a single icon component file using template"""
    return COMPONENT_TEMPLATE.format(
        namespace=config['namespace'],
        icon_name=icon_name,
        viewbox=config['viewbox'],
        default_attributes=generate_default_attributes(config),
        svg_content=svg_content
    )


def validate_generated_code(code: str) -> Optional[str]:
    """
    Basic validation of generated C# code

    Returns error message if invalid, None if valid
    """
    # Check for basic C# syntax elements
    if 'namespace' not in code:
        return "Missing namespace declaration"

    if 'class' not in code:
        return "Missing class declaration"

    if 'BuildRenderTree' not in code:
        return "Missing BuildRenderTree method"

    # Check for balanced braces
    if code.count('{') != code.count('}'):
        return "Unbalanced braces in generated code"

    return None


def generate_components_for_library(
    icon_set: str,
    config: Dict[str, Optional[str]],
    source_dir: Path,
    output_base_dir: Path
) -> int:
    """Generate physical component files for an icon library"""
    source_folder = source_dir / icon_set

    # Output to separate package directory
    output_dir = output_base_dir / config['package_dir'] / "Components"

    print(f"\nProcessing {icon_set} icons...")

    # Validate directories
    if not source_folder.exists():
        print(f"ERROR: Source folder not found: {source_folder}")
        return 0

    # Get all SVG files
    svg_files = sorted(source_folder.glob("*.svg"))

    if not svg_files:
        print(f"WARNING: No SVG files found in {source_folder}")
        return 0

    # Create output directory
    try:
        output_dir.mkdir(parents=True, exist_ok=True)
    except Exception as e:
        print(f"ERROR: Failed to create output directory {output_dir}: {e}")
        return 0

    # Generate a component file for each icon
    processed = 0
    errors = 0

    total_files = len(svg_files)
    print(f"Found {total_files} SVG files")

    for idx, svg_file in enumerate(svg_files, 1):
        # Show progress for large sets
        if total_files > 100 and idx % 100 == 0:
            print(f"  Progress: {idx}/{total_files} ({idx*100//total_files}%)")

        # Validate icon name
        icon_name = convert_to_valid_identifier(
            svg_file.name,
            config.get('prefix', ''),
            config.get('strip_suffix', '')
        )
        validation_error = validate_icon_name(svg_file.stem)
        if validation_error:
            print(f"ERROR: {validation_error}")
            errors += 1
            continue

        # Extract SVG content
        svg_content = extract_svg_content(svg_file)
        if not svg_content:
            errors += 1
            continue

        try:
            # Generate component code
            component_code = generate_component_file(icon_name, svg_content, config)

            # Validate generated code
            validation_error = validate_generated_code(component_code)
            if validation_error:
                print(f"ERROR: Invalid generated code for {icon_name}: {validation_error}")
                errors += 1
                continue

            # Write to file
            output_file = output_dir / f"{icon_name}.cs"
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(component_code)

            processed += 1
        except Exception as e:
            print(f"ERROR: Failed to generate component for {svg_file.name}: {e}")
            errors += 1

    print(f"Generated {processed} icon components in {output_dir}")
    if errors > 0:
        print(f"WARNING: {errors} errors occurred during generation")

    return processed


def main():
    """Main entry point"""
    print("\033[1;36m" + "="*60 + "\033[0m")
    print("\033[1;36mEasyAppDev.Blazor.Icons - Physical Component Generator\033[0m")
    print("\033[1;36m" + "="*60 + "\033[0m\n")

    # Check Python version
    check_python_version()

    # Define paths
    script_dir = Path(__file__).parent
    config_path = script_dir / CONFIG_FILE
    source_dir = script_dir / "icon-sources"
    output_base_dir = script_dir.parent

    # Load configuration from JSON
    print(f"Loading configuration from {CONFIG_FILE}...")
    icon_sets = load_config(config_path)
    print(f"Found {len(icon_sets)} icon set(s) configured\n")

    # Validate source directory exists
    if not source_dir.exists():
        print(f"\033[1;31mERROR: Source directory not found: {source_dir.absolute()}\033[0m")
        print("Please ensure you're running this script from the correct directory.")
        sys.exit(1)

    # Generate components for each icon set
    total = 0
    total_errors = 0

    for icon_set, raw_config in icon_sets.items():
        try:
            # Convert camelCase to snake_case
            config = convert_config_keys(raw_config)
            count = generate_components_for_library(icon_set, config, source_dir, output_base_dir)
            if count:
                total += count
        except Exception as e:
            print(f"\033[1;31mERROR: Failed to process {icon_set}: {e}\033[0m")
            total_errors += 1

    # Summary
    print("\n" + "\033[1;36m" + "="*60 + "\033[0m")
    if total > 0:
        print(f"\033[1;32m✓ Successfully generated {total} total icon components\033[0m")
    else:
        print(f"\033[1;31m✗ No components were generated\033[0m")

    if total_errors > 0:
        print(f"\033[1;31m✗ {total_errors} icon set(s) failed to process\033[0m")

    print("\033[1;36m" + "="*60 + "\033[0m")

    if total > 0:
        print("\n\033[1;36mNext step:\033[0m Build the projects to compile components with trimming support")
        print("  Command: dotnet build")

    sys.exit(0 if total_errors == 0 else 1)


if __name__ == "__main__":
    main()
