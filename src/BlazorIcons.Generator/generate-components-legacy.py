#!/usr/bin/env python3
"""
EasyAppDev.Blazor.Icons - Physical Component Generator

This script generates individual physical .cs component files for each icon.
Each icon becomes a separate sealed ComponentBase class that can be trimmed independently.

This enables true trimming - only referenced icons are included in published output.
"""

import os
import re
from pathlib import Path

# Define icon sets with their configurations
ICON_SETS = {
    "lucide": {
        "namespace": "EasyAppDev.Blazor.Icons.Lucide",
        "package_dir": "EasyAppDev.Blazor.Icons.Lucide",
        "viewbox": "0 0 24 24",
        "fill": "none",
        "stroke": "currentColor",
        "stroke_width": "2",
        "stroke_linecap": "round",
        "stroke_linejoin": "round"
    },
    "bootstrap": {
        "namespace": "EasyAppDev.Blazor.Icons.Bootstrap",
        "package_dir": "EasyAppDev.Blazor.Icons.Bootstrap",
        "viewbox": "0 0 16 16",
        "fill": "currentColor",
        "stroke": None,
        "stroke_width": None,
        "stroke_linecap": None,
        "stroke_linejoin": None
    },
    "material-design": {
        "namespace": "EasyAppDev.Blazor.Icons.MaterialDesign",
        "package_dir": "EasyAppDev.Blazor.Icons.MaterialDesign",
        "viewbox": "0 0 24 24",
        "fill": "currentColor",
        "stroke": None,
        "stroke_width": None,
        "stroke_linecap": None,
        "stroke_linejoin": None
    }
}

def convert_to_valid_identifier(name):
    """Convert filename to valid C# identifier"""
    name = Path(name).stem
    parts = name.split('-')
    result = ''.join(part.capitalize() for part in parts)
    if result[0].isdigit():
        result = f"_{result}"
    return result

def extract_svg_content(svg_path):
    """Extract inner SVG content"""
    try:
        with open(svg_path, 'r', encoding='utf-8') as f:
            content = f.read()

        pattern = r'<svg[^>]*>(.*?)</svg>'
        match = re.search(pattern, content, re.DOTALL)

        if match:
            inner_content = match.group(1).strip()
            # Escape quotes for C# verbatim string
            inner_content = inner_content.replace("\"", "\"\"")
            # Clean up whitespace but preserve structure
            inner_content = re.sub(r'\n\s+', ' ', inner_content)
            return inner_content.strip()
        return None
    except Exception as e:
        print(f"Warning: Failed to parse {svg_path}: {e}")
        return None

def generate_component_file(icon_name, svg_content, config):
    """Generate a single icon component file"""
    template = f'''// <auto-generated/>
#nullable enable

using Microsoft.AspNetCore.Components;
using Microsoft.AspNetCore.Components.Rendering;

namespace {config['namespace']}
{{
    /// <summary>
    /// {icon_name} icon from icon library.
    /// This component is fully embedded and trimmable.
    /// </summary>
    public sealed class {icon_name} : ComponentBase
    {{
        /// <summary>
        /// Accessible label for the icon. If not provided, icon will be marked as decorative (aria-hidden="true").
        /// </summary>
        [Parameter]
        public string? AriaLabel {{ get; set; }}

        /// <summary>
        /// Additional HTML attributes to apply to the SVG element.
        /// </summary>
        [Parameter(CaptureUnmatchedValues = true)]
        public System.Collections.Generic.IReadOnlyDictionary<string, object>? AdditionalAttributes {{ get; set; }}

        /// <inheritdoc/>
        protected override void BuildRenderTree(RenderTreeBuilder builder)
        {{
            builder.OpenElement(0, "svg");
            builder.AddAttribute(1, "xmlns", "http://www.w3.org/2000/svg");
            builder.AddAttribute(2, "viewBox", "{config['viewbox']}");
            builder.AddAttribute(3, "width", "24");
            builder.AddAttribute(4, "height", "24");

            {generate_default_attributes(config)}

            // Add user attributes AFTER defaults so they can override
            if (AdditionalAttributes != null)
            {{
                builder.AddMultipleAttributes(10, AdditionalAttributes);
            }}

            // Accessibility attributes
            if (!string.IsNullOrEmpty(AriaLabel))
            {{
                builder.AddAttribute(11, "role", "img");
                builder.AddAttribute(12, "aria-label", AriaLabel);
            }}
            else
            {{
                builder.AddAttribute(11, "aria-hidden", "true");
            }}

            // Inline SVG content
            builder.AddMarkupContent(13, @"{svg_content}");
            builder.CloseElement();
        }}
    }}
}}
'''
    return template

def generate_default_attributes(config):
    """Generate default SVG attribute assignments"""
    lines = []
    attr_num = 5

    if config.get('fill'):
        lines.append(f'            builder.AddAttribute({attr_num}, "fill", "{config["fill"]}");')
        attr_num += 1

    if config.get('stroke'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke", "{config["stroke"]}");')
        attr_num += 1

    if config.get('stroke_width'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-width", "{config["stroke_width"]}");')
        attr_num += 1

    if config.get('stroke_linecap'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-linecap", "{config["stroke_linecap"]}");')
        attr_num += 1

    if config.get('stroke_linejoin'):
        lines.append(f'            builder.AddAttribute({attr_num}, "stroke-linejoin", "{config["stroke_linejoin"]}");')
        attr_num += 1

    return '\n'.join(lines)

def generate_components_for_library(icon_set, config, source_dir, output_base_dir):
    """Generate physical component files for an icon library"""
    source_folder = source_dir / icon_set

    # Output to separate package directory
    output_dir = output_base_dir / config['package_dir'] / "Components"

    print(f"\nProcessing {icon_set} icons...")

    if not source_folder.exists():
        print(f"Warning: Source folder not found: {source_folder} (skipping)")
        return 0

    # Get all SVG files
    svg_files = sorted(source_folder.glob("*.svg"))

    if not svg_files:
        print(f"Warning: No SVG files found in {source_folder}")
        return 0

    # Create output directory
    output_dir.mkdir(parents=True, exist_ok=True)

    # Generate a component file for each icon
    processed = 0
    for svg_file in svg_files:
        icon_name = convert_to_valid_identifier(svg_file.name)
        svg_content = extract_svg_content(svg_file)

        if svg_content:
            component_code = generate_component_file(icon_name, svg_content, config)
            output_file = output_dir / f"{icon_name}.cs"

            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(component_code)

            processed += 1

    print(f"Generated {processed} icon components in {output_dir}")
    return processed

def main():
    """Main entry point"""
    print("\033[1;36mEasyAppDev.Blazor.Icons - Physical Component Generator\033[0m")
    print("\033[1;36m========================================================\033[0m")

    source_dir = Path("./icon-sources")
    output_base_dir = Path("..")

    total = 0
    for icon_set, config in ICON_SETS.items():
        count = generate_components_for_library(icon_set, config, source_dir, output_base_dir)
        if count:
            total += count

    print(f"\n\033[1;32mGenerated {total} total icon components\033[0m")
    print("\033[1;36m\nNext: Build the projects - components will be compiled with trimming support\033[0m")

if __name__ == "__main__":
    main()
